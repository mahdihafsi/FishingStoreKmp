name: macOS CI — iOS Simulator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios-simulator:
    name: Build iOS (Simulator)
    runs-on: macos-latest
    env:
      # Ajustez ces valeurs si nécessaire
      SCHEME: iosApp
      PROJECT_PATH: iosApp/iosApp.xcodeproj
      # Si vous utilisez un workspace, décommentez et ajustez la ligne suivante.
      # WORKSPACE_PATH: iosApp/iosApp.xcworkspace
      GRADLE_TASK: assemble
      SIMULATOR_NAME: "iPhone SE (3rd generation)"
      SIMULATOR_OS: "18.5"
      DERIVED_DATA: ${{ runner.temp }}/DerivedData

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Gradle tasks
        run: |
          chmod +x ./gradlew
          ./gradlew $GRADLE_TASK --no-daemon

      - name: Dump installed simulators (debug)
        run: xcrun simctl list devices --json

      - name: Build iOS app (produce .app in DerivedData)
        env:
          DERIVED_DATA: ${{ env.DERIVED_DATA }}
        run: |
          set -euo pipefail
          mkdir -p "$DERIVED_DATA"
          echo "Building with derived data: $DERIVED_DATA"
          # If you have a workspace, replace -project by -workspace and PROJECT_PATH by WORKSPACE_PATH.
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGNING_ALLOWED=NO \
            clean build | tee build.log

          APP_PATH=$(find "$DERIVED_DATA/Build/Products" -name "*.app" -print -quit || true)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found in DerivedData ($DERIVED_DATA)" >&2
            ls -la "$DERIVED_DATA" || true
            echo "Last 200 lines of build log:"; tail -n 200 build.log || true
            exit 1
          fi
          echo "Found app: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      - name: Boot/create simulator (robust)
        env:
          SIMULATOR_NAME: "${{ env.SIMULATOR_NAME }}"
          SIMULATOR_OS: "${{ env.SIMULATOR_OS }}"
          TIMEOUT: "120"
        run: |
          set -euo pipefail
          SIM_NAME="${SIMULATOR_NAME:-ci-sim}"
          SIM_OS="${SIMULATOR_OS:-}"
          TARGET_SUFFIX=$(echo "$SIM_OS" | tr '.' '-' || true)
          echo "Target simulator name: $SIM_NAME"
          echo "Requested OS/version: $SIM_OS"

          echo "Available runtimes:"; xcrun simctl list runtimes
          echo "Available device types:"; xcrun simctl list devicetypes

          # find existing exact-name device UDID (any state)
          EXISTING_UDID=$(xcrun simctl list devices | awk -F '[()]' -v name="$SIM_NAME" '$0 ~ name" \\(" {print $2; exit}' | tr -d ' ' || true)

          if [ -n "$EXISTING_UDID" ]; then
            echo "Found existing simulator UDID: $EXISTING_UDID"
            SIMUDID="$EXISTING_UDID"
          else
            echo "No existing simulator named '$SIM_NAME'. Creating one..."

            DEVICE_TYPE_ID=$(xcrun simctl list devicetypes | awk -F '[()]' '/iPhone/ {print $2; exit}' | tr -d ' ' || true)

            # Try to select runtime matching SIMULATOR_OS (e.g. 18.5 => com.apple.CoreSimulator.SimRuntime.iOS-18-5)
            if [ -n "$TARGET_SUFFIX" ]; then
              RUNTIME_ID=$(xcrun simctl list runtimes | grep -oE 'com.apple.CoreSimulator.SimRuntime.iOS[-0-9]+' | grep "$TARGET_SUFFIX" | head -n1 || true)
            fi
            # fallback: first available iOS runtime
            if [ -z "${RUNTIME_ID:-}" ]; then
              RUNTIME_ID=$(xcrun simctl list runtimes | awk -F '[()]' '/iOS/ {print $2; exit}' | tr -d ' ' || true)
            fi

            if [ -z "$DEVICE_TYPE_ID" ] || [ -z "$RUNTIME_ID" ]; then
              echo "Error: cannot detect device type or runtime. Check Xcode/runtimes." >&2
              exit 1
            fi

            echo "Using device type: $DEVICE_TYPE_ID"
            echo "Using runtime: $RUNTIME_ID"
            SIMUDID=$(xcrun simctl create "$SIM_NAME" "$DEVICE_TYPE_ID" "$RUNTIME_ID")
            echo "Created simulator: $SIM_NAME ($SIMUDID)"
          fi

          echo "Booting simulator $SIMUDID..."
          xcrun simctl boot "$SIMUDID" || true

          echo "Waiting for simulator bootstatus (timeout ${TIMEOUT}s)..."
          xcrun simctl bootstatus "$SIMUDID" -b -t "${TIMEOUT}"

          echo "SIMUDID=$SIMUDID" >> "$GITHUB_ENV"

      - name: Install app on simulator (by UDID)
        run: |
          set -euo pipefail
          if [ -z "${APP_PATH:-}" ]; then
            echo "APP_PATH not set; build may have failed." >&2
            exit 1
          fi
          echo "Installing $APP_PATH to $SIMUDID"
          xcrun simctl install "$SIMUDID" "$APP_PATH"

      - name: Extract bundle identifier
        id: bundle
        run: |
          set -euo pipefail
          PLIST="$APP_PATH/Info.plist"
          if [ ! -f "$PLIST" ]; then
            echo "Info.plist not found at $PLIST" >&2
            exit 1
          fi
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST")
          echo "Detected bundle id: $BUNDLE_ID"
          echo "bundle_id=$BUNDLE_ID" >> $GITHUB_OUTPUT

      - name: Launch app on simulator
        run: |
          set -euo pipefail
          echo "Launching ${ { steps.bundle.outputs.bundle_id } } on $SIMUDID"
          xcrun simctl launch "$SIMUDID" "${{ steps.bundle.outputs.bundle_id }}" || true

      - name: Take screenshot
        run: |
          xcrun simctl io "$SIMUDID" screenshot screenshot.png || true

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-screenshot
          path: screenshot.png

      - name: Upload DerivedData
        uses: actions/upload-artifact@v4
        with:
          name: DerivedData
          path: ${{ env.DERIVED_DATA }}
          retention-days: 3

      - name: Shutdown simulator (cleanup)
        if: always()
        run: |
          xcrun simctl shutdown "$SIMUDID" || true
