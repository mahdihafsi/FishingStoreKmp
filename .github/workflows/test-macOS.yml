name: macOS CI — iOS Simulator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SIMULATOR_NAME: "ci-sim"
  IOS_SCHEME: "iosApp"
  IOS_PROJECT: "iosApp/iosApp.xcodeproj"
  IOS_DEST: "platform=iOS Simulator,name=iPhone 15"

jobs:
  ios:
    name: Build iOS app
    runs-on: macos-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install Java (for Gradle / Shared KMM)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Gradle cache
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4 — (OPTIONAL mais recommandé pour KMM)
      - name: Gradle: Build shared KMM framework
        run: ./gradlew :shared:assembleXCFramework

      # 5. Create & Boot simulator (robust)
      - name: Boot/create simulator (robust)
        env:
          SIMULATOR_NAME: "${{ env.SIMULATOR_NAME }}"
          TIMEOUT: "120"
        run: |
          set -euo pipefail
          SIM_NAME="${SIMULATOR_NAME:-ci-sim}"
          echo "Simulator name: $SIM_NAME"

          echo "Available runtimes:"
          xcrun simctl list runtimes
          echo "Available device types:"
          xcrun simctl list devicetypes

          EXISTING_UDID=$(xcrun simctl list devices | grep -F "$SIM_NAME (" | awk -F '[()]' '{print $2}' | tr -d ' ' || true)

          if [ -n "$EXISTING_UDID" ]; then
            echo "Found existing simulator: $EXISTING_UDID"
            SIMUDID="$EXISTING_UDID"
          else
            echo "No existing simulator, creating one..."
            DEVICE_TYPE_ID=$(xcrun simctl list devicetypes | awk -F '[()]' '/iPhone/ {print $2; exit}' | tr -d ' ' || true)
            RUNTIME_ID=$(xcrun simctl list runtimes | awk -F '[()]' '/iOS/ {print $2; exit}' | tr -d ' ' || true)

            if [ -z "$DEVICE_TYPE_ID" ] || [ -z "$RUNTIME_ID" ]; then
              echo "Error: cannot detect a valid device type/runtime" >&2
              exit 1
            fi

            SIMUDID=$(xcrun simctl create "$SIM_NAME" "$DEVICE_TYPE_ID" "$RUNTIME_ID")
            echo "Created simulator: $SIMUDID"
          fi

          echo "Booting simulator..."
          xcrun simctl boot "$SIMUDID" || true

          echo "Waiting for bootstatus..."
          xcrun simctl bootstatus "$SIMUDID" -b -t "${TIMEOUT}"

          echo "SIMUDID=$SIMUDID" >> $GITHUB_ENV

      # 6. Build iOS app from Xcode (Debug or Release)
      - name: Xcode build (debug)
        run: |
          xcodebuild \
            -project $IOS_PROJECT \
            -scheme $IOS_SCHEME \
            -destination "platform=iOS Simulator,id=$SIMUDID" \
            -configuration Debug \
            clean build | xcpretty

      # 7. (OPTIONAL) Export archive .xcarchive artifact
      - name: Archive iOS app
        run: |
          xcodebuild \
            -project $IOS_PROJECT \
            -scheme $IOS_SCHEME \
            -destination "platform=iOS Simulator,id=$SIMUDID" \
            -configuration Release \
            -archivePath build/ios.xcarchive \
            archive | xcpretty

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: build/ios.xcarchive
