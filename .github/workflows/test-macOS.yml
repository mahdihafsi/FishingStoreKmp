name: macOS CI — iOS Simulator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-ios-simulator:
    name: Build iOS (Simulator)
    runs-on: macos-latest

    env:
      SCHEME: iosApp
      PROJECT_PATH: iosApp/iosApp.xcodeproj
      GRADLE_TASK: assemble
      SIMULATOR_NAME: "iPhone SE (3rd generation)"
      DERIVED_DATA: ${{ github.workspace }}/DerivedData

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run Gradle tasks
        run: |
          chmod +x ./gradlew
          ./gradlew $GRADLE_TASK --no-daemon

      - name: Dump installed simulators (debug)
        run: xcrun simctl list devices --json

      - name: Build iOS app (xcodebuild)
        run: |
          mkdir -p "$DERIVED_DATA"

          echo "Using PROJECT_PATH=${PROJECT_PATH}"
          echo "Using SCHEME=${SCHEME}"

          xcodebuild \
            -project "${PROJECT_PATH}" \
            -scheme "${SCHEME}" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGNING_ALLOWED=NO

      - name: Find built .app
        id: find_app
        run: |
          APP_PATH=$(find "${DERIVED_DATA}/Build/Products" -name "*.app" | head -n1)
          if [ -z "$APP_PATH" ]; then
            echo "❌ No .app found"
            ls -R "${DERIVED_DATA}"
            exit 1
          fi
          echo "Found .app → $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

      - name: Boot simulator
        run: |
          SIMUDID=$(xcrun simctl list devices | awk -F '[()]' -v name="$SIMULATOR_NAME" '$0 ~ name" \\(" {print $2; exit}')
          if [ -z "$SIMUDID" ]; then
            echo "❌ Simulator not found"
            xcrun simctl list devices
            exit 1
          fi

          echo "Booting → $SIMUDID"
          xcrun simctl boot "$SIMUDID" || true
          xcrun simctl bootstatus "$SIMUDID" -b -t 120

          echo "SIMUDID=$SIMUDID" >> $GITHUB_ENV

      - name: Install app
        run: |
          xcrun simctl install "$SIMUDID" "${{ steps.find_app.outputs.app_path }}"

      - name: Extract bundle identifier
        id: bundle
        run: |
          PLIST="${{ steps.find_app.outputs.app_path }}/Info.plist"
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$PLIST")
          echo "bundle_id=$BUNDLE_ID" >> $GITHUB_OUTPUT

      - name: Launch app
        run: |
          xcrun simctl launch "$SIMUDID" "${{ steps.bundle.outputs.bundle_id }}" || true

      - name: Take screenshot
        run: |
          xcrun simctl io "$SIMUDID" screenshot screenshot.png || true

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: ios-screenshot
          path: screenshot.png

      - name: Upload DerivedData
        uses: actions/upload-artifact@v4
        with:
          name: DerivedData
          path: ${{ env.DERIVED_DATA }}

      - name: Shutdown simulator
        if: always()
        run: |
          xcrun simctl shutdown "$SIMUDID" || true
